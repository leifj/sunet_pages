<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Utimaco MSSQL EKM Provider User Guide: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Utimaco MSSQL EKM Provider User Guide
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Utimaco MSSQL EKM Provider User Guide Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="history"></a>
Change History</h1>
<hr/>
<table  class="doxtable">
<tr>
<th>Date </th><th>Author </th><th>Comment </th><th>Documentation Version  </th></tr>
<tr>
<td>16.08.2010 </td><td>Dipl.-Ing. (FH) Sebastian Pranzkat<br/>
Utimaco IS GmbH </td><td>initial version </td><td>1.0.0  </td></tr>
<tr>
<td>30.08.2012 </td><td>Dipl.-Ing. (FH) Sebastian Pranzkat<br/>
Utimaco IS GmbH </td><td>added note for MSSQLSERVER user </td><td>1.0.1  </td></tr>
</table>
<p><br/>
 <br/>
 <br/>
</p>
<h1><a class="anchor" id="intro"></a>
Introduction</h1>
<hr/>
<p>This guide illustrates the use of Microsoft's extensible key management and explains the key features. It is not exhaustive. For an overview of all features and functions see Microsoft EKM specifications.</p>
<p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="features"></a>
Features</h1>
<hr/>
<h2><a class="anchor" id="platforms"></a>
Supported Platforms</h2>
<p>Actually the Utimaco EKM Provider (hereinafter called "Provider") supports:<br/>
</p>
<ul>
<li><b>Microsoft</b> <b>SQL</b> <b>Server</b> <b>2008</b> (with SP 1) on <b>Windows</b> <b>Server</b> <b>2008</b> </li>
<li><b>Microsoft</b> <b>SQL</b> <b>Server</b> <b>2008</b> <b>R2</b> on <b>Windows</b> <b>Server</b> <b>2008</b> <b>R2</b> </li>
</ul>
<h2><a class="anchor" id="algorithms"></a>
Supported Algorithms</h2>
<p>The Provider supports the following algorithms:</p>
<table  class="doxtable">
<tr>
<th>Algorithm </th><th>Algorithm Tag (in SQL) </th><th>Bit Length </th><th>IV Length   </th></tr>
<tr>
<td>DES </td><td>DES </td><td>64 </td><td>64  </td></tr>
<tr>
<td>Triple DES </td><td>TRIPLE_DES </td><td>128 </td><td>64  </td></tr>
<tr>
<td>Triple DES 3 </td><td>TRIPLE_DES_3KEY </td><td>192 </td><td>64  </td></tr>
<tr>
<td>AES 128 </td><td>AES_128 </td><td>128 </td><td>128  </td></tr>
<tr>
<td>AES 192 </td><td>AES_192 </td><td>192 </td><td>128  </td></tr>
<tr>
<td>AES 256 </td><td>AES_256 </td><td>256 </td><td>128  </td></tr>
<tr>
<td>RSA 512 </td><td>RSA_512 </td><td>512 </td><td>N/A  </td></tr>
<tr>
<td>RSA 1024 </td><td>RSA_1024 </td><td>1024 </td><td>N/A  </td></tr>
<tr>
<td>RSA 2048 </td><td>RSA_2048 </td><td>2048 </td><td>N/A  </td></tr>
</table>
<p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="config"></a>
Configuration</h1>
<hr/>
 <h2><a class="anchor" id="config_file"></a>
Configuration file</h2>
<p>The Provider must be configured using a configuration file. The file can be created using a simple text editor like Notepad <br/>
 and copy and paste the following sample configuration.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># This is a sample configuration file</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"># path to logfile</span></div>
<div class="line"><span class="preprocessor"></span>LogFile = c:/Program Files/Utimaco/CryptoServer/Software/EKM/ekm.log </div>
<div class="line"><span class="preprocessor"># loglevel </span></div>
<div class="line"><span class="preprocessor"></span>LogLevel = 3 </div>
<div class="line"><span class="preprocessor"># maximum logsize in bytes</span></div>
<div class="line"><span class="preprocessor"></span>LogSize = 1000000  </div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># path to the EKM Keystore</span></div>
<div class="line"><span class="preprocessor"></span>KeyStore = c:/Program Files/Utimaco/CryptoServer/Software/EKM/EKM.sdb  </div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># local CryptoServer device</span></div>
<div class="line"><span class="preprocessor"></span>Device = PCI:0    </div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># remote CryptoServer</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#Device = 192.168.1.2  </span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor"># cluster of CryptoServer</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#Device = PCI:0 192.168.4.183 \ </span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#     192.168.4.184 \</span></div>
<div class="line"><span class="preprocessor">#     192.168.4.185 \</span></div>
<div class="line"><span class="preprocessor">#     192.168.4.186 \ </span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#     192.168.4.187  </span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"># timeout on connection attempt</span></div>
<div class="line"><span class="preprocessor"></span>ConnectionTimeout = 5000</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># command timeout   </span></div>
<div class="line"><span class="preprocessor">Timeout = 60000         </span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Config file can be adjusted for your needs. E.g. change the logfile path or the keystore path if necessary and configure the device name of your CryptoServer. <br/>
 General rules for config file:<ul>
<li>leading and trailing blanks are stripped on keys and values.</li>
<li>a key may not contain blanks.</li>
<li>a configuration value may contain blanks (e.g. 'Device = c:/program files/myapp/config').</li>
<li>backward slashes are used to indicate that a value is continued on the next line.</li>
<li>a backward slash may not follow immediately to a value, at least one blank has to separate value and backward slash.</li>
<li>backward slashes may not be used within values, even on Windows forward slashes have to be used within path names.</li>
<li>a char ('#') may be used to comment out the current line.</li>
<li>a char may only be placed in front of a key.</li>
<li>invalid lines are ignored.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="config_path"></a>
Configuration Path</h2>
<p>After creating the config file (e.g. <em>ekm.cfg</em>) the path to the config file must be set in the Provider. <br/>
 To do so, create a new registry key in the <b>HKEY_LOCAL_MACHINE</b> <b>SOFTWARE</b> section. <br/>
 The key name is <b>Utimaco</b>. In this key create a new key with name <b>EKM</b> and a string value named <b>ConfigPath</b>. <br/>
 The value must point to the path where the configuration file is located (e.g. <em>C:\Program</em> <em>Files\Utimaco\EKM\ekm.cfg</em>) <br/>
 Alternatively an environment variable named <em>EKMCONFIGPATH</em> can be set. <br/>
 The environment variable is used first if the registry key as well as the variable is configured. <br/>
</p>
<ul>
<li>Registry key <b>HKEY_LOCAL_MACHINE\SOFTWARE\Utimaco\EKM</b> <br/>
 with string value <b>ConfigPath</b> </li>
<li>Alternatively: environment variable named <b>EKMCONFIGPATH</b> </li>
</ul>
<dl class="section note"><dt>Note</dt><dd>installing the product-cd will create a default config file (sample_ekm.cfg) and a registry entry. Rename the config file and adjust the file to your needs. <br/>
 If Microsoft SQL Server uses the NT Service\MSSQLSERVER account, make sure to grant this user read access to the configuration file cssqlekm.cfg. <br/>
 <br/>
 <br/>
</dd></dl>
<h1><a class="anchor" id="install_prov"></a>
Installing the Provider</h1>
<hr/>
 <h2><a class="anchor" id="enable_provider"></a>
Enabling EKM in SQL Server</h2>
<p>To use the provider it must be first activated in the Microsoft SQL Server <br/>
 executing the following command:</p>
<div class="fragment"><div class="line">sp_configure <span class="stringliteral">&#39;show advanced options&#39;</span>, 1;</div>
<div class="line">RECONFIGURE;</div>
<div class="line">sp_configure <span class="stringliteral">&#39;EKM provider enabled&#39;</span>, 1;</div>
<div class="line">RECONFIGURE;</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Microsoft SQL Server Enterprise Edition must be installed to use the EKM feature</dd></dl>
<h2><a class="anchor" id="load_dll"></a>
Loading the Dll</h2>
<dl class="section note"><dt>Note</dt><dd>execute the steps explained in <a class="el" href="index.html#config">Configuration</a> first before continue.</dd></dl>
<p>To load the provider dll execute:</p>
<div class="fragment"><div class="line">CREATE CRYPTOGRAPHIC PROVIDER utimaco</div>
<div class="line">FROM FILE = <span class="stringliteral">&#39;&lt;path-to-provider-dll&gt;&#39;</span></div>
</div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">CREATE CRYPTOGRAPHIC PROVIDER utimaco</div>
<div class="line">FROM FILE = <span class="stringliteral">&#39;C:\Program Files\Utimaco\CryptoServer\Lib\ &lt;OS&gt; \cssqlekm.dll&#39;</span></div>
</div><!-- fragment --><p>The command should be executed successful and the provider <br/>
 should be loaded. Check this by executing</p>
<div class="fragment"><div class="line">SELECT * FROM Sys.dm_cryptographic_provider_properties</div>
</div><!-- fragment --><p><br/>
 </p>
<h2><a class="anchor" id="alter_dll"></a>
Alter Dll</h2>
<p>To alter to a new provider dll execute</p>
<div class="fragment"><div class="line">ALTER CRYPTOGRAPHIC PROVIDER utimaco</div>
<div class="line">FROM FILE = <span class="stringliteral">&#39;&lt;path-to-new-provider-dll&gt;&#39;</span></div>
</div><!-- fragment --><p><br/>
 </p>
<h2><a class="anchor" id="drop_dll"></a>
Drop Dll</h2>
<p>To drop the provider dll execute</p>
<div class="fragment"><div class="line">DROP CRYPTOGRAPHIC PROVIDER utimaco</div>
</div><!-- fragment --><p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="creatUser"></a>
Creating User</h1>
<hr/>
<h2><a class="anchor" id="cryptoUser"></a>
CryptoServer User</h2>
<p>To use the provider a user in the CryptoServer must be generated. The user must belong to the group <em>CXI_GROUP</em> with a level of 2 in group 0. <br/>
 <br/>
 e.g. Paul with 00000002{CXI_GROUP=PaulGroup} <br/>
 <br/>
 </p>
<h2><a class="anchor" id="msUser"></a>
MSSQL User</h2>
<p>To create a SQL credential execute:</p>
<div class="fragment"><div class="line">CREATE CREDENTIAL &lt;credential-name&gt; WITH IDENTITY=<span class="stringliteral">&#39;&lt;CryptoServer-User&gt;@&lt;CXI_GROUP&gt;&#39;</span>,</div>
<div class="line">SECRET=<span class="stringliteral">&#39;&lt;CryptoServer-User-Password&gt;&#39;</span></div>
<div class="line">FOR CRYPTOGRAPHIC PROVIDER utimaco</div>
</div><!-- fragment --><p>e.g.</p>
<div class="fragment"><div class="line">CREATE CREDENTIAL PaulCred WITH IDENTITY=<span class="stringliteral">&#39;Paul@PaulGroup&#39;</span>,</div>
<div class="line">SECRET=<span class="stringliteral">&#39;password&#39;</span></div>
<div class="line">FOR CRYPTOGRAPHIC PROVIDER utimaco</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Password of CryptoServer-User and Password of the SQL-Credential must be the same</dd></dl>
<p>To map the new credential to a login execute</p>
<div class="fragment"><div class="line">ALTER LOGIN &lt;SQL-login&gt; ADD CREDENTIAL &lt;credential-name&gt;</div>
</div><!-- fragment --><p>For example: </p>
<div class="fragment"><div class="line">ALTER LOGIN Paul ADD CREDENTIAL PaulCred</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Keys which are created by the example-user Paul are only accessible by users in CXI_GROUP PaulGroup. If keys should be accessible by all users a user with permission 00000002{CXI_GROUP=*} is necessary. Than the SQL credential should be created like this: <div class="fragment"><div class="line">CREATE CREDENTIAL &lt;credential-name&gt; WITH IDENTITY=<span class="stringliteral">&#39;&lt;CryptoServer-User&gt;&#39;</span>,</div>
<div class="line">SECRET=<span class="stringliteral">&#39;&lt;CryptoServer-User-Password&gt;&#39;</span></div>
<div class="line">FOR CRYPTOGRAPHIC PROVIDER utimaco</div>
</div><!-- fragment --></dd></dl>
<p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="using_prov"></a>
Using the provider</h1>
<hr/>
<h2><a class="anchor" id="create_key"></a>
Create keys</h2>
<p>To create a new symmetric key execute</p>
<div class="fragment"><div class="line">CREATE SYMMETRIC KEY &lt;key name in SQL database&gt;</div>
<div class="line">FROM Provider utimaco</div>
<div class="line">WITH ALGORITHM = &lt;algorithm&gt;,</div>
<div class="line">PROVIDER_KEY_NAME = <span class="stringliteral">&#39;&lt;key name in CryptoServer database&gt;&#39;</span>,</div>
<div class="line">CREATION_DISPOSITION=CREATE_NEW</div>
</div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">CREATE SYMMETRIC KEY EKM_UTIMACO_AES_256</div>
<div class="line">FROM Provider utimaco</div>
<div class="line">WITH ALGORITHM = AES_256,</div>
<div class="line">PROVIDER_KEY_NAME = <span class="stringliteral">&#39;EKM_AES_256&#39;</span>,</div>
<div class="line">CREATION_DISPOSITION=CREATE_NEW</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>a list with supported algorithms and their tags is located here <a class="el" href="index.html#algorithms">Supported Algorithms</a></dd></dl>
<p>To create a new asymmetric key execute</p>
<div class="fragment"><div class="line">CREATE ASYMMETRIC KEY &lt;key name in SQL database&gt;</div>
<div class="line">FROM Provider utimaco</div>
<div class="line">WITH ALGORITHM = &lt;algorithm&gt;,</div>
<div class="line"> PROVIDER_KEY_NAME = <span class="stringliteral">&#39;&lt;key name in CryptoServer database&gt;&#39;</span>,</div>
<div class="line"> CREATION_DISPOSITION=CREATE_NEW</div>
</div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">CREATE ASYMMETRIC KEY EKM_UTIMACO_RSA_2048</div>
<div class="line">FROM Provider utimaco</div>
<div class="line">WITH ALGORITHM = RSA_2048,</div>
<div class="line">PROVIDER_KEY_NAME = <span class="stringliteral">&#39;EKM_RSA_2048&#39;</span>,</div>
<div class="line">CREATION_DISPOSITION=CREATE_NEW</div>
</div><!-- fragment --><p>To access a (asymmetric) key that is already in the EKM keystore but not in the SQL database execute</p>
<div class="fragment"><div class="line">CREATE ASYMMETRIC KEY &lt;key name in SQL database&gt;</div>
<div class="line">FROM Provider utimaco</div>
<div class="line">WITH</div>
<div class="line">PROVIDER_KEY_NAME = <span class="stringliteral">&#39;&lt;key name in CryptoServer database&gt;&#39;</span>,</div>
<div class="line">CREATION_DISPOSITION=OPEN_EXISTING</div>
</div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">CREATE ASYMMETRIC KEY EKM_UTIMACO_RSA_512</div>
<div class="line">FROM Provider utimaco </div>
<div class="line">WITH</div>
<div class="line">PROVIDER_KEY_NAME = <span class="stringliteral">&#39;EKM_RSA_512&#39;</span>,</div>
<div class="line">CREATION_DISPOSITION=OPEN_EXISTING</div>
</div><!-- fragment --><p><br/>
 </p>
<h2><a class="anchor" id="view_keys"></a>
View keys</h2>
<p>To view keys available in SQL database execute</p>
<div class="fragment"><div class="line">Select * from master.sys.symmetric_keys</div>
</div><!-- fragment --><p>for symmetric keys or</p>
<div class="fragment"><div class="line">Select * from master.sys.asymmetric_keys</div>
</div><!-- fragment --><p>for asymmetric keys. <br/>
</p>
<p>To view keys in the provider execute</p>
<div class="fragment"><div class="line">SELECT * FROM sys.dm_cryptographic_provider_keys(&lt;providerID&gt;)</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>provider id is located in the table <em>dm_cryptographic_provider_properties</em> </dd></dl>
<p><br/>
 </p>
<h2><a class="anchor" id="drop_keys"></a>
Drop keys</h2>
<p>To drop key (only) from SQL database execute</p>
<div class="fragment"><div class="line">DROP SYMMETRIC KEY &lt;key name&gt;</div>
</div><!-- fragment --><p>for a symmetric key or</p>
<div class="fragment"><div class="line">DROP ASYMMETRIC KEY &lt;key name&gt;</div>
</div><!-- fragment --><p>for an asymmetric one. <br/>
 The key than stays in the provider. If the key should also be deleted from the provider execute</p>
<div class="fragment"><div class="line">DROP SYMMETRIC KEY &lt;key name&gt; REMOVE PROVIDER KEY</div>
</div><!-- fragment --><p>for a symmetric key or</p>
<div class="fragment"><div class="line">DROP ASYMMETRIC KEY &lt;key name&gt; REMOVE PROVIDER KEY</div>
</div><!-- fragment --><p>for an asymmetric one. <br/>
 <br/>
 E.g. the key EKM_UTIMACO_AES_256 will be dropped (in SQL and in the provider) by this command:</p>
<div class="fragment"><div class="line">DROP SYMMETRIC KEY EKM_UTIMACO_AES_256 REMOVE PROVIDER KEY</div>
</div><!-- fragment --><p><br/>
 </p>
<h2><a class="anchor" id="enc_dec_data"></a>
Encrypting and decrypting single parts of a table</h2>
<p>The procedure <b>EncryptByKey</b> is used to encrypt data using a symmetric key.<br/>
 <br/>
 <b>Example:</b> <br/>
 Create a new table executing</p>
<div class="fragment"><div class="line">Create table dbo.test (First_Name varchar(max) not null, Second_Name varchar(max) not null, Address varchar(max) not null)</div>
</div><!-- fragment --><p>A new entry with an encrypted <em>address</em> is now created due this command</p>
<div class="fragment"><div class="line">INSERT INTO dbo.test</div>
<div class="line">values(<span class="stringliteral">&#39;Paul&#39;</span>,<span class="stringliteral">&#39;Anderson&#39;</span>, EncryptByKey(Key_GUID(<span class="stringliteral">&#39;EKM_UTIMACO_AES_256&#39;</span>), <span class="stringliteral">&#39;Hollywood Hills&#39;</span>))</div>
</div><!-- fragment --><p>The address row of this entry is now encrypted by the key <em>EKM_UTIMACO_AES_256</em>. <br/>
 <br/>
 To encrypt a row using a asymmetric key the procedure <b>EncryptByAsymKey</b> is used. <br/>
 <br/>
 <b>Example:</b> <br/>
 <br/>
 A new entry in the table dbo.test with an encrypted address is created due this command</p>
<div class="fragment"><div class="line">INSERT INTO dbo.test</div>
<div class="line">values(<span class="stringliteral">&#39;Mister&#39;</span>,<span class="charliteral">&#39;X&#39;</span>, EncryptByAsymKey(AsymKey_Id(<span class="stringliteral">&#39;EKM_UTIMACO_RSA_2048&#39;</span>), <span class="stringliteral">&#39;London Street&#39;</span>))</div>
</div><!-- fragment --><p> <br/>
</p>
<p>To decrypt the address of the first column encrypted with a symmetric key execute</p>
<div class="fragment"><div class="line">SELECT CONVERT(varchar(MAX),DecryptByKey(Address))</div>
<div class="line">Address FROM dbo.test where First_Name = &#39;Paul&#39;</div>
</div><!-- fragment --><p>To decrypt the address of the second column encrypted with an asymmetric key execute</p>
<div class="fragment"><div class="line">SELECT CONVERT(varchar(MAX),DecryptByAsymKey(AsymKey_Id(<span class="stringliteral">&#39;EKM_UTIMACO_RSA_2048&#39;</span>),Address))</div>
<div class="line">Address FROM dbo.test where First_Name = &#39;Mister&#39;</div>
</div><!-- fragment --><p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="tde"></a>
Using the provider with transparent database encryption (TDE)</h1>
<hr/>
 <h2><a class="anchor" id="intro_tde"></a>
Introduction</h2>
<p>The TDE feature encrypts total databases completely transparent for the user. <br/>
 This means the user can create, drop and view data in a TDE encrypted database like in a unencrypted one. <br/>
 A database encryption key (DEK) is used to encrypt/decrypt the database(s). <br/>
 An asymmetric key residing on the EKM provider can be used to encrypt the DEK. <br/>
 This add a more comprehensive key management to database encryption.</p>
<p><br/>
 </p>
<h2><a class="anchor" id="ena_tde"></a>
Enable TDE</h2>
<p>Create a asymmetric key used to encrypt the DEK (see <a class="el" href="index.html#create_key">Create keys</a>).</p>
<dl class="section note"><dt>Note</dt><dd><b>Be sure to backup this key. <br/>
 If this key is lost it is impossible to access the database anymore.</b></dd></dl>
<p>Create a credential protected by this key executing</p>
<div class="fragment"><div class="line">CREATE CREDENTIAL &lt;tde-credential-name&gt;</div>
<div class="line">WITH IDENTITY = <span class="stringliteral">&#39;&lt;CryptoServer-User&gt;&#39;</span>,</div>
<div class="line">SECRET = <span class="stringliteral">&#39;&lt;CryptoServer-Password&gt;&#39;</span></div>
<div class="line">FOR CRYPTOGRAPHIC PROVIDER utimaco</div>
</div><!-- fragment --><p>Create a login for the TDE executing</p>
<div class="fragment"><div class="line">CREATE LOGIN &lt;login-name&gt;</div>
<div class="line">FROM ASYMMETRIC KEY &lt;asymmetric-key-name&gt;</div>
</div><!-- fragment --><p>Bind the new credential to the login executing</p>
<div class="fragment"><div class="line">ALTER LOGIN &lt;login-name&gt;</div>
<div class="line">ADD CREDENTIAL &lt;tde-credential-name&gt;</div>
</div><!-- fragment --><p>Change to the database that should be encrypted</p>
<div class="fragment"><div class="line">USE &lt;database-name&gt;</div>
</div><!-- fragment --><p>Create the DEK for this database executing</p>
<div class="fragment"><div class="line">CREATE DATABASE ENCRYPTION KEY</div>
<div class="line">WITH ALGORITHM = &lt;algorithm&gt;</div>
<div class="line">ENCRYPTION BY SERVER ASYMMETRIC KEY &lt;key name in SQL database&gt;</div>
</div><!-- fragment --><p>To enable TDE encryption execute</p>
<div class="fragment"><div class="line">ALTER DATABASE &lt;database-name&gt;</div>
<div class="line">SET ENCRYPTION ON </div>
</div><!-- fragment --><p>Now the database is encrypted.</p>
<p><br/>
 </p>
<h2><a class="anchor" id="display_enc_state"></a>
Display encryption state of the databases</h2>
<p>To display the encryption states of the databases execute</p>
<div class="fragment"><div class="line">SELECT DB_NAME(e.database_id) AS DatabaseName, e.database_id,</div>
<div class="line">e.encryption_state,</div>
<div class="line">CASE e.encryption_state</div>
<div class="line">WHEN 0 THEN &#39;No database encryption key present, no encryption&#39;</div>
<div class="line">WHEN 1 THEN &#39;Unencrypted&#39;</div>
<div class="line">WHEN 2 THEN &#39;Encryption in progress&#39;</div>
<div class="line">WHEN 3 THEN &#39;Encrypted&#39;</div>
<div class="line">WHEN 4 THEN &#39;Key change in progress&#39;</div>
<div class="line">WHEN 5 THEN &#39;Decryption in progress&#39;</div>
<div class="line">END AS encryption_state_desc, c.name, e.percent_complete</div>
<div class="line">FROM sys.dm_database_encryption_keys AS e</div>
<div class="line">LEFT JOIN master.sys.asymmetric_keys AS c</div>
<div class="line">ON e.encryptor_thumbprint = c.thumbprint</div>
</div><!-- fragment --><p>Databases which are encrypted will be listed as <em>Encrypted</em>.</p>
<p><br/>
 <br/>
 <br/>
 </p>
<h1><a class="anchor" id="backup_restore"></a>
Backup and restore keys</h1>
<hr/>
<p>It is important to backup generated keys and the MBK to ensure that the data can be decrypted even if the server has a defect. To backup the master-box-key (MBK) see <a class="el" href="_references.html#adminGuide">[1]</a>. The MBK is the key-encryption-key (KEK). All keys which are generated by the EKM are encrypted by the MBK and will be stored in the keystore. The keystore location is configured in the configuration file (see <a class="el" href="index.html#config_file">Configuration file</a>). Backup this keystore (simply copy the file) to save the encrypted keys. During backup you should ensure that no write operations will take place on the keystore. This might result in a corrupt keystore and therefore in a corrupt backup of it. To restore the keys on another server, copy the keystore file and follow the EKM UserGuide and Microsoft EKM documentation. To restore the MBK after a CryptoServer defect see <a class="el" href="_references.html#adminGuide">[1]</a>.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>backup MBK</li>
<li>backup keystore by simply copy the keystore file <br/>
 ensure that no write operations will take place on the keystore during backup </li>
</ul>
</dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
