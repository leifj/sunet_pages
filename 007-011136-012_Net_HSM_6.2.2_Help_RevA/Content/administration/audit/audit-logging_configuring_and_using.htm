<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="index.xml" data-mc-path-to-help-system="../../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-medium="non-print" data-mc-toc-path="Administration Guide|Audit Logging">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>Configuring and Using Audit Logging</title>
        <link href="../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../Resources/TableStyles/Breadcrumbs.css" rel="stylesheet" />
        <link href="../../Resources/Stylesheets/Gemalto_Template_Enterprise.css" rel="stylesheet" />
        <script src="../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <table style="width: 100%;border-spacing: 0px 0px;mc-table-style: url('../../Resources/TableStyles/Breadcrumbs.css');border-left-style: none;border-left-width: 1px;border-left-color: #000000;border-right-style: none;border-right-width: 1px;border-right-color: #000000;border-top-style: none;border-top-width: 0px;border-top-color: #000000;border-bottom-style: solid;border-bottom-width: 2px;border-bottom-color: #e6e6e6;" class="TableStyle-Breadcrumbs" cellspacing="0">
            <col style="width: 41px;" class="TableStyle-Breadcrumbs-Column-Column1" />
            <col class="TableStyle-Breadcrumbs-Column-Column1" />
            <tbody>
                <tr class="TableStyle-Breadcrumbs-Body-Body1">
                    <th class="TableStyle-Breadcrumbs-BodyB-Column1-Body1">
                        <p class="home" style="font-weight: normal;"><a href="../../Home_sa.htm">Home</a> &gt;
                        </p>
                    </th>
                    <th class="TableStyle-Breadcrumbs-BodyA-Column1-Body1">
                        <div class="MCBreadcrumbsBox_0"><span class="MCBreadcrumbsPrefix">  <![CDATA[ ]]></span><span class="MCBreadcrumbsSelf">Administration Guide</span><span class="MCBreadcrumbsDivider"> &gt; </span><a class="MCBreadcrumbsLink" href="audit.htm">Audit Logging</a><span class="MCBreadcrumbsDivider"> &gt; </span><span class="MCBreadcrumbs">Configuring and Using Audit Logging</span>
                        </div>
                    </th>
                </tr>
            </tbody>
        </table>
        <h2>Configuring and Using Audit Logging</h2>
        <p>The overall sequence when initializing an HSM that will use Security Audit Logging is as follows:</p>
        <p class="ol1Start" data-mc-autonum="1."><span class="autonumber"><span class="ol1Number">1.</span></span><strong>Configure the SafeNet Network HSM appliance or the SafeNet PCIe HSM/SafeNet USB HSM host workstation to use the network time protocol (NTP).</strong>
        </p>
        <p class="listLevel1">  Configure access to at least two geographically separated NTP servers for redundancy.  Select at least one NTP server that is known to have a high degree of accuracy and reliability (servers associated with national standards bodies are good candidates) as one of the configured servers.</p>
        <p class="ol1" data-mc-autonum="2."><span class="autonumber"><span class="ol1Number">2.</span></span><strong>Initialize the Audit Officer role.</strong>
        </p>
        <p class="listLevel1">  This enables logging for all subsequent actions performed by the SO and partition User(s).</p>
        <p class="ol1" data-mc-autonum="3."><span class="autonumber"><span class="ol1Number">3.</span></span><strong>Execute the ‘audit sync’ command.</strong>
        </p>
        <p class="listLevel1">This ensures that the HSM’s clock is synchronized with the host time (which should also be synchronized with the NTP server) and that all subsequent log records will have a valid and accurate timestamp.</p>
        <p class="ol1" data-mc-autonum="4."><span class="autonumber"><span class="ol1Number">4.</span></span><strong>Configure the audit category and level of audit</strong>
        </p>
        <p class="listLevel1"> You can specify the level of audit appropriate for needs of the organization’s policy and the nature of the application(s) using the HSM.  Security audits can generate a very large amount of data, which consumes  HSM processing resources, host storage resources, and makes the job of the Audit Officer quite difficult when it comes time to review the logs. For this reason, ensure that you configure audit logging such that you  capture only relevant data, and no more.  </p>
        <p class="listLevel1">For example, the ‘First Key Usage Only’ category is intended to assist Audit Officers to capture the relevant data in a space-efficient manner for high processing volume applications. On the other hand, a top-level Certificate Authority would likely be required, by policy, to capture all operations performed on the HSM but, since it is typically not an application that would see high volumes, configuring the HSM to audit all events would not impose a significant space and/or performance premium in that situation.</p>
        <p class="ol1" data-mc-autonum="5."><span class="autonumber"><span class="ol1Number">5.</span></span><strong>Configure log rotation and remote logging server(s) as necessary.</strong>
        </p>
        <p class="listLevel1">  The settings for these configuration elements will often be dictated by the organization’s Audit and/or IT policies and procedures.  As with configuring the audit category, the Audit Officer should be prudent in making these configuration settings.  It is recommended that the default setting of ‘Rotate Log Daily’ be maintained until the typical/average logging rate can be determined.  The use of redundant remote log servers, accessible only by the members of the audit team, is strongly recommended.</p>
        <p class="ol1" data-mc-autonum="6."><span class="autonumber"><span class="ol1Number">6.</span></span><strong>Initialize the HSM and create partitions as necessary.</strong>
        </p>
        <p class="listLevel1">  At this point, the HSM is ready to be turned over to the SO to initialize it and begin creating the partitions needed to serve the processing applications.</p>
        <h3 data-mc-conditions="Default.SA">Configure Audit Logging for SafeNet Network HSM &#160;</h3>
        <p data-mc-conditions="Default.SA">This section describes how to prepare and use audit logging with your SafeNet Network HSM.</p>
        <p data-mc-conditions="Default.SA">Required SafeNet Network HSM appliance version is 5.2 or later; HSM firmware version is 6.10.9 or later.</p>
        <p data-mc-conditions="Default.SA">In summary, the steps are:</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>Log into the appliance as "audit"&#160;user.</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>Initialize, to create the role on the HSM.</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>Configure the various logging parameters.</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>Begin collecting and verifying logs of HSM activities.</p>
        <p data-mc-conditions="Default.SA">The first time you log into the SafeNet appliance as user "audit", you are prompted to change the password, from default "PASSWORD" to something more secure: </p><pre xml:space="preserve" class="listLevel2" data-mc-conditions="Default.SA">

login as: audit
audit@192.20.11.202's password:
Last login: Wed Feb 11 11:02:12 2015 from 172.20.10.181

SafeNet Network HSM 6.0.0 Command Line Shell - Copyright (c) 2001-2015 SafeNet, Inc. All 
           rights reserved.


*****************************************************
**                                                 **
**   For security purposes, you must change your   **
**   password.                                     **
**                                                 **
**   Please ensure you store your new password     **
**   in a secure location.                         **
**                                                 **
**               DO NOT LOSE IT!                   **
**                                                 **
*****************************************************

Changing password for user audit.

You can now choose the new password.

A valid password should be a mix of upper and lower case letters,
digits, and other characters.  You can use an 8 character long
password with characters from at least 3 of these 4 classes.
An upper case letter that begins the password and a digit that
ends it do not count towards the number of character classes used.

Enter new password:
Re-type new password:
passwd: all authentication tokens updated successfully.
Password change successful)

[sa5] lunash:&gt;


</pre>
        <p data-mc-conditions="Default.SA">The audit user sees a reduced subset of commands suitable to the audit role, only.</p><pre xml:space="preserve" data-mc-conditions="Default.SA">

 Name                 (short)    Description
 --------------------------------------------------------------------------------
 help                 he         Get Help
 exit                 e          Exit Luna Shell
 hsm                  hs         &gt; Hsm
 audit                a          &gt; Audit
 my                   m          &gt; My
 network              n          &gt; Network &#160;&#160;

&#160;&#160;&#160;</pre>
        <p data-mc-conditions="Default.SA">The audit user's commands are not available to the admin user. The audit user has no administrative control over the SafeNet Network HSM appliance. This is a first layer in the separation of roles. </p>
        <p data-mc-conditions="Default.SA">This separation allows a user with no administrative control of the appliance and HSM to have oversight of the HSM logs, while also ensuring that an administrator cannot clear those logs,</p>
        <h5 data-mc-conditions="Default.SA">To configure audit logging on SafeNet Network HSM</h5>
        <p class="ol1Start" data-mc-autonum="1." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">1.</span></span>Using an SSH connection (or a local serial connection), log into the SafeNet appliance as "audit" (not as "admin"). &#160;&#160;</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">The default password is "PASSWORD". Ensure that you change the default password to a secure password. To fulfill the purpose of the Audit role, keep the "audit"&#160;user's password separate from, and unknown to, the HSM&#160; Security Officer. &#160;&#160;</p>
        <p class="ol1" data-mc-autonum="2." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">2.</span></span>Initialize the <b>audit</b> role on the HSM: &#160;&#160;</p>
        <p class="ol1" data-mc-autonum="3." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">3.</span></span>lunash:&gt; <b>audit init</b></p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span>On password-authenticated HSMs, you are prompted for a domain string and password</p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span>On PED-authenticated HSMs, you are referred to SafeNet PED, which prompts for a white PED Key. &#160;&#160;</p>
        <p class="ol1" data-mc-autonum="4." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">4.</span></span>Now that the <b>audit</b> role exists on the HSM, the auditing function must be configured. However, before you can configure you must log into the HSM as the <b>audit</b> user: &#160;</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">lunash:&gt; <b>audit login</b></p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span>On password-authenticated HSMs, you are prompted to enter the password for the <b>audit</b> user.</p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span>On PED-authenticated HSMs, you are referred to SafeNet PED, which prompts for the white PED Key for the <b>audit</b> user. &#160;&#160;</p>
        <p class="note" data-mc-autonum="&lt;b&gt;Note:&lt;/b&gt; &#160;" data-mc-conditions="Default.SA"><span class="autonumber"><span><b>Note:</b> &#160;</span></span>You are now logged into the appliance as user "audit" and into the HSM (within the appliance) as user "audit". Both are required. The "audit" commands, including HSM login as "audit". do not appear if you are logged in as "admin", "operator", "user", or any equivalent named appliance-level user.</p>
        <p class="ol1" data-mc-autonum="5." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">5.</span></span>Configure  audit logging: </p>
        <p class="listLevel1" data-mc-conditions="Default.SA">lunash:&gt; <b>audit config</b> <![CDATA[ ]]></p>
        <p class="note" data-mc-autonum="&lt;b&gt;Note:&lt;/b&gt; &#160;" data-mc-conditions="Default.SA"><span class="autonumber"><span><b>Note:</b> &#160;</span></span>The first time you configure audit logging, we suggest using only the "?" option, in order to see all the available options in the configuration process.</p>
        <p class="listLevel1" data-mc-conditions="Default.SA"> For example, the command <b>audit config -p e -v all</b> will log everything the HSM does. This might be useful in some circumstances, but will quickly fill up log files. The command <b>audit config -p r -v h</b> would rotate the logs every hour, cutting down the size of individual log files, even in a situation of high-volume event recording, but would increase the number of files to be handled.</p>
        <h4 data-mc-conditions="Default.SA">Log Entries</h4>
        <p data-mc-conditions="Default.SA">Log entries are made within the HSM, and are written to the currently active log file on the appliance file system. When a log file reaches the rotation trigger, it is closed, and a new file gets the next log entry. The number log files on the appliance grows according to the logging settings and the rotation schedule that you configured (above). At any time, you can copy files to a remote computer and then clear the originals from the HSM, if you wish to free the space. </p>
        <p data-mc-conditions="Default.SA">For SafeNet Network HSM, to simplify configuration within its closed and hardened environment, the&#160;following rules apply:</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>the maximum log file size is capped at 4 MB &#160;&#160;</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>the log path is internal to the SafeNet HSM appliance</p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;" data-mc-conditions="Default.SA"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>the rotation offset is set at 0. </p>
        <h3>Audit Log Operational Activities</h3>
        <h5 data-mc-conditions="Default.SA">To copy files off the appliance</h5>
        <p class="ol1Start" data-mc-autonum="1." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">1.</span></span>View a list of the log files currently saved on the appliance:</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">lunash:&gt;<b>my file list</b></p>
        <p class="ol1" data-mc-autonum="2." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">2.</span></span>For this example, assume that the list includes a file named <b>audit.tgz</b>.</p>
        <p class="ol1" data-mc-autonum="3." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">3.</span></span>On the computer where you wish to capture and store the log files:</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">/usr/safenet/lunaclient/logs :&gt;scp audit@mylunasa1:audit.tgz mylunsa1_audit_2014-02-28.tgz</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">Provide the audit user's credentials when prompted. This copies the identified file from the remote SafeNet Network HSM's file system (in the "audit" account) and stores the copy on your local computer file system with a useful name.<br /></p>
        <p class="ol1" data-mc-autonum="4." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">4.</span></span>You can view and parse the plain-text portion of the file.</p>
        <p class="ol1" data-mc-autonum="5." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">5.</span></span>You can verify the authenticity of the retrieved file using a connected HSM to which you have imported the Audit Logging secret from the originating SafeNet Network HSM.<br /></p>
        <h5 data-mc-conditions="Default.SA">To export the Audit Logging secret from the HSM and import to the verifying HSM</h5>
        <p class="ol1Start" data-mc-autonum="1." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">1.</span></span>On the SafeNet Network HSM where HSM audit log files are being created, export the audit logging secret:</p>
        <p class="listLevel1" data-mc-conditions="Default.SA">lunash:&gt; <b>audit secret export</b></p>
        <p class="ol1" data-mc-autonum="2." data-mc-conditions="Default.SA"><span class="autonumber"><span class="ol1Number">2.</span></span>Use <b>my file list</b> to see the file name of the wrapped log secret. <br /></p>
        <p class="ol1" data-mc-autonum="3." data-mc-conditions=""><span class="autonumber"><span class="ol1Number">3.</span></span>On the computer where the HSM is attached, that you will use to verify the downloaded audit log file, run: </p>
        <p class="listLevel1" data-mc-conditions="">/usr/safenet/lunaclient/bin :&gt;scp audit@mylunasa1:151170.lws . </p>
        <p class="listLevel1" data-mc-conditions="">Substitute the actual file name of the exported secret in the above example command) and provide the audit user's credentials when prompted. This copies the identified file from the remote SafeNet Network HSM's file system (in the "audit" account) and stores the copy on your local computer file system in the directory from which you issued the command.</p>
        <p class="ol1" data-mc-autonum="4." data-mc-conditions=""><span class="autonumber"><span class="ol1Number">4.</span></span>Launch LunaCM, </p>
        <p class="listLevel1" data-mc-conditions="">/usr/safenet/lunaclient/bin :&gt;<b>./lunacm</b> <![CDATA[ ]]></p>
        <p class="ol1" data-mc-autonum="5." data-mc-conditions=""><span class="autonumber"><span class="ol1Number">5.</span></span>For this example, we will assume that you have initialized the HSM Audit User role, using the same domain/secret as is associated with the source SafeNet Network HSM. </p>
        <p class="ol1" data-mc-autonum="6." data-mc-conditions=""><span class="autonumber"><span class="ol1Number">6.</span></span>Import the Audit Logging secret into the locally attached HSM: &#160;&#160;</p>
        <p class="listLevel1" data-mc-conditions="">lunacm:&gt;<b>audit import file</b> 151170.lws <br /></p>
        <p class="ol1" data-mc-autonum="7." data-mc-conditions=""><span class="autonumber"><span class="ol1Number">7.</span></span>Verify the file:&#160;&#160;</p>
        <p class="listLevel1" data-mc-conditions="">lunacm:&gt;<b>audit verify file</b> mylunsa1_audit_2014-02-28.tgz</p>
        <p class="listLevel1" data-mc-conditions="">You might need to provide the full path to the file, depending upon your current environment settings. &#160;&#160;</p>
        <h3>Deciphering the audit log records</h3>
        <p>In general, the audit logs are self-explanatory. Due to limitations in the firmware, however, some audit log records required further explanation, as detailed in the following sections:</p>
        <h4>Determining the serial number of a created partition from the audit log</h4>
        <p>An audit log entry similar to the following is generated when a partition is created on the HSM:</p><pre xml:space="preserve">5,12/12/17 16:14:14,S/N 150718 session 1 Access 2147483651:2669 SO container operation LUNA_CREATE_CONTAINER returned RC_OK(0x00000000) container=20 (using PIN (entry=LUNA_ENTRY_DATA_AREA))</pre>
        <p>It is not obvious from this entry what the serial number is for the created partition. This information, however, can be derived from the log entry, since the partition serial number is simply a concatenation of the HSM serial number and the partition container number, which are specified in the log entry, as highlighted below:</p><pre xml:space="preserve">5,12/12/17 16:14:14,S/N <span style="color: #f39100;">150718</span> session 1 Access 2147483651:2669 SO container operation LUNA_CREATE_CONTAINER returned RC_OK(0x00000000) container=<span style="color: #f39100;">20</span> (using PIN (entry=LUNA_ENTRY_DATA_AREA))</pre>
        <p>In the example above, the HSM serial number is 150718 and the partition container number is 20. Note that the partition container number is a three-digit number with leading zeros suppressed, so that the actual partition container number is 020. To determine the partition serial number  concatenate the two numbers as follows:</p><pre xml:space="preserve">150718020</pre>
        <p>Use this number to identify the partition in subsequent audit log entiries.</p>
        <h3>Additional Considerations</h3>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>The audit role PED key or password is a critical property to manage the audit logs. If that authentication secret is lost, the HSM must be factory reset (that is, zeroize the HSM) in order to initialize the audit role again. This is equivalent to the same situation for the HSM's Security Officer (SO). &#160;&#160; </p>
        <p class="ul1" data-mc-autonum="&lt;b&gt;•&lt;/b&gt;"><span class="autonumber"><span class="ul1Bullet"><b>•</b></span></span>&#160;Multiple bad logins produce different results for the SO and for the audit role, as follows:</p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span> &#160;&#160;After 3 bad SO logins, the LUNA_RET_SO_LOGIN_FAILURE_THRESHOLD error is returned and the HSM is zeroized.</p>
        <p class="ul2" data-mc-autonum="&lt;b&gt;–&lt;/b&gt;"><span class="autonumber"><span class="ul2Bullet"><b>–</b></span></span> &#160;&#160;After 3 bad audit logins, the LUNA_RET_AUDIT_LOGIN_FAILURE_THRESHOLD error is returned, but the HSM is unaffected. If subsequent login attempt is executed within 30 seconds, the LUNA_RET_AUDIT_LOGIN_TIMEOUT_IN_PROGRESS error is returned. If you wait for more than 30 seconds and try login again with the correct password, the login is successful. &#160;</p>
        <p class="footer"><span class="DefaultProduct">SafeNet Network HSM</span> <span class="DefaultRelease">6.2.2</span> <span class="DefaultProjectTitle">Product Documentation</span> <br /><span class="DefaultPartNumber">007-011136-012</span> <span class="DefaultRevision">Rev. A</span> <span style="color: #5e5e5c;"><![CDATA[  ]]></span> <span class="DefaultDateLong">01 December 2016</span> <span style="color: #5e5e5c;"><![CDATA[  ]]></span> <span class="DefaultCopyright">Copyright 2001-2016</span>&#160;<span class="DefaultCompanyNameLong">Gemalto</span> <span style="color: #5e5e5c;"><![CDATA[  ]]></span>All rights reserved. </p>
    </body>
</html>